<html>
  <head>
    <title>Admin Review Panel - CAPTCHA Labeling Tool</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.css" />
    <style>
      .review-sure {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
      }
      .review-not-sure {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
      }
      .review-pending {
        background-color: #f8f9fa;
      }
      .admin-image-row {
        transition: background-color 0.2s;
      }
      .saving-indicator {
        display: none;
        color: #28a745;
        font-size: 0.9em;
      }
      .saving-indicator.active {
        display: inline;
      }
      .review-status-badge {
        font-size: 0.85em;
        padding: 4px 8px;
      }
      .pagination-controls {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row mb-3">
        <div class="col-8">
          <h1 class="mt-4 mb-3">Admin Review Panel</h1>
        </div>
        <div class="col-4 text-right mt-4">
          {% if username %}
          <div>
            <span class="mr-3">Logged in as: <strong>{{ username }}</strong></span>
            <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">Logout</button>
          </div>
          {% else %}
          <div>
            <a href="/login?next=/admin" class="btn btn-sm btn-primary">Login</a>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="row mb-3">
        <div class="col-12">
          <div class="alert alert-info">
            <strong>Instructions:</strong> Review labeled images. Mark as "Sure" if the label is correct, 
            "Not Sure" if uncertain, and edit values if needed. Click "Save Review" to save changes.
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <label for="siteFilter" class="mr-2"><strong>Filter by Site:</strong></label>
              <select id="siteFilter" class="form-control d-inline-block" style="width: auto; margin-right: 15px;">
                <option value="">All Sites</option>
              </select>
              <div class="form-check d-inline-block ml-3">
                <input class="form-check-input" type="checkbox" id="hideReviewed" />
                <label class="form-check-label" for="hideReviewed">
                  Hide Reviewed Items
                </label>
              </div>
              <span id="progressText" class="ml-3">Loading...</span>
              <span class="saving-indicator" id="savingIndicator"> â€¢ Saving...</span>
            </div>
            <div>
              <a href="/" class="btn btn-secondary">Back to Labeling</a>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-12">
          <div class="pagination-controls">
            <button id="prevPage" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
            <span class="mx-3">
              Page 
              <input 
                type="number" 
                id="pageInput" 
                class="form-control form-control-sm d-inline-block" 
                style="width: 60px; text-align: center;"
                min="1" 
                value="1"
              />
              of <span id="totalPages">1</span>
            </span>
            <button id="nextPage" class="btn btn-sm btn-outline-primary" disabled>Next</button>
            <span class="ml-3">
              <label for="perPageSelect">Items per page:</label>
              <select id="perPageSelect" class="form-control form-control-sm d-inline-block" style="width: auto;">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
            </span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <table class="table table-bordered">
            <thead class="thead-light">
              <tr>
                <th style="width: 8%;">Site</th>
                <th style="width: 10%;">Filename</th>
                <th style="width: 15%;">Image</th>
                <th style="width: 15%;">Label Value</th>
                <th style="width: 12%;">Labeled By</th>
                <th style="width: 15%;">Review Status</th>
                <th style="width: 15%;">Reviewed By</th>
                <th style="width: 10%;">Actions</th>
              </tr>
            </thead>
            <tbody id="imagesTableBody">
              <tr>
                <td colspan="8" class="text-center">Loading images...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12">
          <button id="saveAllReviews" class="btn btn-lg btn-success">
            Save All Reviews
          </button>
        </div>
      </div>

      <!-- User Management Section -->
      {% if username %}
      <div class="row mt-5">
        <div class="col-12">
          <h2>User Management</h2>
          <div class="card">
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-12">
                  <h5>Add/Edit User</h5>
                  <form id="userForm" class="form-inline">
                    <div class="form-group mr-2">
                      <input
                        type="text"
                        class="form-control"
                        id="userUsername"
                        placeholder="Username"
                        required
                      />
                    </div>
                    <div class="form-group mr-2">
                      <input
                        type="password"
                        class="form-control"
                        id="userPassword"
                        placeholder="Password (leave blank to keep existing)"
                      />
                    </div>
                    <div class="form-check mr-2">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="userIsAdmin"
                      />
                      <label class="form-check-label" for="userIsAdmin">
                        Admin
                      </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save User</button>
                    <button type="button" class="btn btn-secondary ml-2" id="cancelEditBtn" style="display: none;">Cancel</button>
                  </form>
                </div>
              </div>
              <div class="row">
                <div class="col-12">
                  <h5>Users</h5>
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Username</th>
                        <th>Admin</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="usersTableBody">
                      <tr>
                        <td colspan="3" class="text-center">Loading users...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        const NULL_MARKER = "__NULL__";
        let currentPage = 1;
        let perPage = 50;
        let totalPages = 1;
        let currentImages = [];
        let pendingReviews = {}; // Track unsaved changes
        let selectedSite = ""; // Empty means all sites
        let hideReviewed = false;

        // Load sites and images on page load
        loadSites();
        loadImages();
        
        // Site filter change handler
        $("#siteFilter").change(function() {
          selectedSite = $(this).val() || "";
          currentPage = 1;
          loadImages();
        });

        // Hide reviewed filter handler
        $("#hideReviewed").change(function() {
          hideReviewed = $(this).is(':checked');
          currentPage = 1;
          loadImages();
        });

        // Pagination handlers
        $("#prevPage").click(function() {
          if (currentPage > 1) {
            currentPage--;
            loadImages();
          }
        });

        $("#nextPage").click(function() {
          if (currentPage < totalPages) {
            currentPage++;
            loadImages();
          }
        });

        $("#perPageSelect").change(function() {
          perPage = parseInt($(this).val());
          currentPage = 1;
          loadImages();
        });

        // Page input handler
        $("#pageInput").on('keypress', function(e) {
          if (e.which === 13) { // Enter key
            e.preventDefault();
            const pageNum = parseInt($(this).val());
            if (pageNum >= 1 && pageNum <= totalPages) {
              currentPage = pageNum;
              loadImages();
            } else {
              $(this).val(currentPage); // Reset to current page if invalid
            }
          }
        });

        // Update page input when page changes externally
        $("#pageInput").on('blur', function() {
          const pageNum = parseInt($(this).val());
          if (pageNum >= 1 && pageNum <= totalPages) {
            if (pageNum !== currentPage) {
              currentPage = pageNum;
              loadImages();
            }
          } else {
            $(this).val(currentPage); // Reset to current page if invalid
          }
        });

        function loadSites() {
          $.ajax({
            url: "/api/sites",
            method: "GET",
            success: function(response) {
              if (response.success) {
                const select = $("#siteFilter");
                // Keep "All Sites" option
                const allSitesOption = select.find('option[value=""]');
                select.empty().append(allSitesOption);
                
                response.sites.forEach(function(site) {
                  select.append($('<option>').val(site).text(site));
                });
              }
            },
            error: function() {
              // Silently fail
            }
          });
        }
        
        function loadImages() {
          $("#imagesTableBody").html('<tr><td colspan="8" class="text-center">Loading images...</td></tr>');
          
          const requestData = {
            page: currentPage,
            per_page: perPage
          };
          if (selectedSite) {
            requestData.site = selectedSite;
          }
          if (hideReviewed) {
            requestData.hide_reviewed = "true";
          }
          
          $.ajax({
            url: "/api/admin/images",
            method: "GET",
            data: requestData,
            success: function(response) {
              if (response.success) {
                currentImages = response.images;
                totalPages = response.total_pages;
                currentPage = response.page;
                
                updatePaginationControls();
                renderImages();
                updateProgressText(response.total);
              } else {
                showError("Failed to load images");
              }
            },
            error: function(xhr, status, error) {
              let errorMsg = "Error loading images";
              if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
              } else if (xhr.statusText) {
                errorMsg = `Error loading images: ${xhr.statusText}`;
              }
              console.error("Admin images error:", xhr, status, error);
              showError(errorMsg);
            }
          });
        }

        function updatePaginationControls() {
          $("#currentPage").text(currentPage);
          $("#totalPages").text(totalPages);
          $("#pageInput").val(currentPage).attr("max", totalPages);
          $("#prevPage").prop("disabled", currentPage <= 1);
          $("#nextPage").prop("disabled", currentPage >= totalPages);
        }

        function updateProgressText(total) {
          $("#progressText").text(`Total labeled images: ${total}`);
        }

        function renderImages() {
          const tbody = $("#imagesTableBody");
          tbody.empty();

          if (currentImages.length === 0) {
            tbody.html('<tr><td colspan="8" class="text-center">No labeled images found.</td></tr>');
            return;
          }

          currentImages.forEach(function(image) {
            const site = image.site || "";
            const filename = image.filename;
            const value = image.value === NULL_MARKER ? "" : image.value;
            const adminReview = image.admin_review;
            const status = adminReview ? adminReview.status : null;
            const labeledBy = image.labeled_by || "unknown";
            const reviewedBy = adminReview ? (adminReview.reviewed_by || "unknown") : "-";
            
            // Determine row class based on review status
            let rowClass = "review-pending";
            if (status === "sure") {
              rowClass = "review-sure";
            } else if (status === "not_sure") {
              rowClass = "review-not-sure";
            }

            const row = $('<tr>')
              .addClass('admin-image-row')
              .addClass(rowClass)
              .attr('data-filename', filename)
              .attr('data-site', site);

            // Site
            row.append($('<td>').text(site));

            // Filename
            row.append($('<td>').text(filename));

            // Image
            const imgCell = $('<td>');
            const img = $('<img>')
              .attr('src', `/results/${site}/img/${filename}`)
              .attr('loading', 'lazy')
              .css('max-width', '100%')
              .css('height', 'auto')
              .on('error', function() {
                $(this).replaceWith($('<span>').text('Image not found').css('color', '#dc3545'));
              });
            imgCell.append(img);
            row.append(imgCell);

            // Label value input
            const inputCell = $('<td>');
            const input = $('<input>')
              .attr('type', 'text')
              .addClass('form-control')
              .addClass('admin-label-input')
              .attr('data-filename', filename)
              .val(value);
            
            if (value === "" && image.value === NULL_MARKER) {
              input.css('font-style', 'italic').css('color', '#856404');
            }
            
            inputCell.append(input);
            row.append(inputCell);

            // Labeled By
            row.append($('<td>').text(labeledBy));

            // Review status
            const statusCell = $('<td>');
            if (status) {
              const badge = $('<span>')
                .addClass('badge')
                .addClass(status === 'sure' ? 'badge-success' : 'badge-warning')
                .addClass('review-status-badge')
                .text(status === 'sure' ? 'Sure' : 'Not Sure');
              statusCell.append(badge);
            } else {
              statusCell.append($('<span>').text('Not reviewed').css('color', '#6c757d'));
            }
            row.append(statusCell);

            // Reviewed By
            row.append($('<td>').text(reviewedBy));

            // Actions
            const actionsCell = $('<td>');
            const btnGroup = $('<div>').addClass('btn-group').attr('role', 'group');
            
            const sureBtn = $('<button>')
              .addClass('btn btn-sm')
              .addClass(status === 'sure' ? 'btn-success' : 'btn-outline-success')
              .text('Sure')
              .attr('data-filename', filename)
              .attr('data-status', 'sure')
              .click(function() {
                setReviewStatus(site, filename, 'sure', row);
              });
            
            const notSureBtn = $('<button>')
              .addClass('btn btn-sm')
              .addClass(status === 'not_sure' ? 'btn-warning' : 'btn-outline-warning')
              .text('Not Sure')
              .attr('data-filename', filename)
              .attr('data-status', 'not_sure')
              .click(function() {
                setReviewStatus(site, filename, 'not_sure', row);
              });
            
            btnGroup.append(sureBtn).append(notSureBtn);
            actionsCell.append(btnGroup);
            row.append(actionsCell);

            tbody.append(row);
          });

          // Handle input changes
          $(".admin-label-input").on("input", function() {
            const filename = $(this).data("filename");
            const row = $(this).closest("tr");
            const site = row.data("site") || "";
            const newValue = $(this).val();
            markAsChanged(site, filename);
          });
        }

        function setReviewStatus(site, filename, status, row) {
          // Update UI immediately
          row.removeClass("review-sure review-not-sure review-pending");
          if (status === "sure") {
            row.addClass("review-sure");
          } else if (status === "not_sure") {
            row.addClass("review-not-sure");
          }

          // Update buttons
          const sureBtn = row.find('button[data-status="sure"]');
          const notSureBtn = row.find('button[data-status="not_sure"]');
          if (status === "sure") {
            sureBtn.removeClass("btn-outline-success").addClass("btn-success");
            notSureBtn.removeClass("btn-warning").addClass("btn-outline-warning");
          } else {
            sureBtn.removeClass("btn-success").addClass("btn-outline-success");
            notSureBtn.removeClass("btn-outline-warning").addClass("btn-warning");
          }

          // Update status badge (now at index 5)
          const statusCell = row.find("td").eq(5);
          if (status === "sure") {
            statusCell.html('<span class="badge badge-success review-status-badge">Sure</span>');
          } else {
            statusCell.html('<span class="badge badge-warning review-status-badge">Not Sure</span>');
          }
          
          // Update reviewed_by column (index 6) - will be updated when saved
          // For now, just mark as pending
          const reviewedByCell = row.find("td").eq(6);
          if (reviewedByCell.text() === "-") {
            reviewedByCell.text("pending");
          }

          // Track change with site
          const key = `${site}:${filename}`;
          if (!pendingReviews[key]) {
            pendingReviews[key] = { site: site, filename: filename };
          }
          pendingReviews[key].status = status;
          markAsChanged(site, filename);
        }

        function markAsChanged(site, filename) {
          const key = `${site}:${filename}`;
          if (!pendingReviews[key]) {
            pendingReviews[key] = { site: site, filename: filename };
          }
          const input = $(`.admin-label-input[data-filename="${filename}"]`);
          pendingReviews[key].value = input.val();
        }

        function saveAllReviews() {
          if (Object.keys(pendingReviews).length === 0) {
            showInfo("No changes to save");
            return;
          }

          const reviews = [];
          for (const key in pendingReviews) {
            const review = pendingReviews[key];
            // Only include status if it was explicitly set
            const reviewData = {
              site: review.site,
              filename: review.filename,
              value: review.value
            };
            if (review.status !== undefined) {
              reviewData.status = review.status;
            }
            reviews.push(reviewData);
          }

          $("#savingIndicator").addClass("active");

          $.ajax({
            url: "/api/admin/review",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ reviews: reviews }),
            success: function(response) {
              $("#savingIndicator").removeClass("active");
              if (response.success) {
                pendingReviews = {};
                showSuccess("Reviews saved successfully");
                // Reload to get updated data
                setTimeout(function() {
                  loadImages();
                }, 500);
              } else {
                showError(response.message || "Failed to save reviews");
              }
            },
            error: function(xhr) {
              $("#savingIndicator").removeClass("active");
              const message = xhr.responseJSON?.message || "Error saving reviews";
              showError(message);
            }
          });
        }

        $("#saveAllReviews").click(saveAllReviews);

        function showSuccess(message) {
          new Noty({
            type: "success",
            text: message,
            timeout: 3000,
            theme: "relax",
          }).show();
        }

        function showError(message) {
          new Noty({
            type: "error",
            text: message,
            timeout: 5000,
            theme: "relax",
          }).show();
        }

        function showInfo(message) {
          new Noty({
            type: "info",
            text: message,
            timeout: 2000,
            theme: "relax",
          }).show();
        }

        // User Management
        let editingUsername = null;

        function loadUsers() {
          $.ajax({
            url: "/api/admin/users",
            method: "GET",
            success: function(response) {
              if (response.success) {
                renderUsers(response.users);
              }
            },
            error: function() {
              $("#usersTableBody").html('<tr><td colspan="3" class="text-center text-danger">Error loading users</td></tr>');
            }
          });
        }

        function renderUsers(users) {
          const tbody = $("#usersTableBody");
          tbody.empty();

          if (users.length === 0) {
            tbody.html('<tr><td colspan="3" class="text-center">No users found</td></tr>');
            return;
          }

          users.forEach(function(user) {
            const row = $('<tr>');
            row.append($('<td>').text(user.username));
            row.append($('<td>').html(user.is_admin ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-secondary">No</span>'));
            
            const actionsCell = $('<td>');
            const editBtn = $('<button>')
              .addClass('btn btn-sm btn-primary mr-1')
              .text('Edit')
              .click(function() {
                editUser(user);
              });
            const deleteBtn = $('<button>')
              .addClass('btn btn-sm btn-danger')
              .text('Delete')
              .click(function() {
                deleteUser(user.username);
              });
            actionsCell.append(editBtn).append(deleteBtn);
            row.append(actionsCell);
            
            tbody.append(row);
          });
        }

        function editUser(user) {
          editingUsername = user.username;
          $("#userUsername").val(user.username).prop('disabled', true);
          $("#userPassword").val("").attr('placeholder', 'Leave blank to keep existing password');
          $("#userIsAdmin").prop('checked', user.is_admin);
          $("#cancelEditBtn").show();
          $("#userForm button[type='submit']").text('Update User');
        }

        function cancelEdit() {
          editingUsername = null;
          $("#userForm")[0].reset();
          $("#userUsername").prop('disabled', false);
          $("#userPassword").attr('placeholder', 'Password');
          $("#cancelEditBtn").hide();
          $("#userForm button[type='submit']").text('Save User');
        }

        $("#userForm").submit(function(e) {
          e.preventDefault();
          const username = $("#userUsername").val().trim();
          const password = $("#userPassword").val();
          const isAdmin = $("#userIsAdmin").is(':checked');

          if (!username) {
            showError("Username is required");
            return;
          }

          if (!editingUsername && !password) {
            showError("Password is required for new users");
            return;
          }

          const userData = {
            username: username,
            is_admin: isAdmin
          };
          if (password) {
            userData.password = password;
          }

          $.ajax({
            url: "/api/admin/users",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(userData),
            success: function(response) {
              if (response.success) {
                showSuccess("User saved successfully");
                cancelEdit();
                loadUsers();
              } else {
                showError(response.message || "Failed to save user");
              }
            },
            error: function(xhr) {
              const message = xhr.responseJSON?.message || "Error saving user";
              showError(message);
            }
          });
        });

        $("#cancelEditBtn").click(cancelEdit);

        function deleteUser(username) {
          if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
            return;
          }

          $.ajax({
            url: `/api/admin/users/${username}`,
            method: "DELETE",
            success: function(response) {
              if (response.success) {
                showSuccess("User deleted successfully");
                loadUsers();
              } else {
                showError(response.message || "Failed to delete user");
              }
            },
            error: function(xhr) {
              const message = xhr.responseJSON?.message || "Error deleting user";
              showError(message);
            }
          });
        }

        // Logout handler
        $("#logoutBtn").click(function() {
          $.ajax({
            url: "/logout",
            method: "POST",
            success: function() {
              window.location.href = "/login?next=/admin";
            },
            error: function() {
              window.location.href = "/login?next=/admin";
            }
          });
        });

        // Load users on page load
        {% if username %}
        loadUsers();
        {% endif %}
      });
    </script>
  </body>
</html>

